{% extends "base.twig" %}

{% block title %}{{ comment_top.comment|length > 16 ? comment_top.comment|slice(0, 16) ~ '…' : comment_top.comment }}{% endblock %}
{% block contents %}
    {% if info %}
        <div class="message content">
            <ul class="message__lists">
                <li>{{ info }}</li>
            </ul>
        </div>
    {% endif %}
    {% if error %}
        <div class="message message--error content">
            <ul class="message__lists">
                <li>{{ error }}</li>
            </ul>
        </div>
    {% endif %}
    {% if comments %}
        <div class="row">
            <article class="comments column">
                {% set comment = comment_top %}
                <section class="comment js-comment comment_top" id="top"
                         data-comment="{{- comment.comment | trim }}">
                    <header class="comment__header">
                        {% set isSigned = comment.user_name and comment.user_image_url %}
                        <div>
                            <div class="comment__header__wrap">
                                {% if isSigned %}
                                    <img class="comment__header__wrap__icon" src="{{ comment.user_image_url }}" width="48" height="48" alt="{{ comment.user_name }}">
                                {% else %}
                                    <img class="comment__header__wrap__icon" src="http://via.placeholder.com/48x48"
                                         alt="匿名ユーザー">
                                {% endif %}
                            </div>
                            <div class="comment__header__username">
                                {% if isSigned %}
                                    @{{ comment.user_name }}
                                {% else %}
                                    匿名ユーザー
                                {% endif %}
                            </div>
                        </div>
                        <div class="comment__header__createdat">
                            <a href="{{ path_for('comment', {'comment_id': comment.comment_id}) }}">{{ comment.createdAtStr }}</a>
                        </div>
                    </header>
                    <main class="comment__main" v-cloak>
                        <div id="{{ comment.comment_id }}" v-show="!editing"
                             v-html="comment_computed">
                        </div>
                        {% if comment.photo_url %}
                            <div class="comment_main__photo">
                                <img src="https://s3-{{ region }}.amazonaws.com/{{ bucket }}/{{ comment.photo_url }}"
                                     alt="{{ comment.comment }}">
                            </div>
                        {% endif %}
                    </main>
                    <footer class="comment__footer">
                        <div>
                            &nbsp;
                        </div>
                        <div>
                            そうだね&#215;<span
                                    id="like-{{ comment.comment_id }}_like">{{ comment.like_count }}</span>
                        </div>
                    </footer>
                </section>
            </article>
        </div>
    {% endif %}
    <div class="row">
        <article class="comments column">
            {% if comments %}
                <div class="comments__sort">
                    <form action="{{ path_for('thread') }}" method="get" class="form--inline">
                        <input type="hidden" name="thread_id" value="{{ thread_id }}">
                        <select name="sort">
                            <option value="asc" {% if sort == "asc" %}selected{% endif %}>古い順</option>
                            <option value="desc" {% if sort == "desc" %}selected{% endif %}>新しい順</option>
                        </select>
                        <input type="submit" value="並び順を変更" class="comments__sort__button">
                    </form>
                </div>
            {% endif %}
        </article>
    </div>
    {% if sort == 'desc' %}
        {% include "comment_form.twig" with {
            'thread_id': thread_id,
            'sort': sort,
            'user_id': user_id,
            'nameKey': nameKey,
            'name': name,
            'valueKey': valueKey,
            'value': value,
            'user': user
        } %}
    {% endif %}
    <div class="row">
        <article class="comments column">
            {% if comments %}
                {% for comment in comments %}
                    <section class="comment js-comment" id="c{{ comment.comment_id }}"
                             data-comment="{{- comment.comment | trim }}">
                        <header class="comment__header">
                            {% set isSigned = comment.user_name and comment.user_image_url %}
                            <div>
                                <div class="comment__header__wrap">
                                    {% if isSigned %}
                                        <img class="comment__header__wrap__icon" src="{{ comment.user_image_url }}" width="48" height="48" alt="{{ comment.user_name }}">
                                    {% else %}
                                        <img class="comment__header__wrap__icon" src="http://via.placeholder.com/48x48"
                                             alt="匿名ユーザー">
                                    {% endif %}
                                </div>
                                <div class="comment__header__username">
                                    {% if isSigned %}
                                        @{{ comment.user_name }}
                                    {% else %}
                                        匿名ユーザー
                                    {% endif %}
                                </div>
                            </div>
                            <div class="comment__header__createdat">
                                <a href="{{ path_for('comment', {'comment_id': comment.comment_id}) }}">{{ comment.createdAtStr }}</a>
                            </div>
                        </header>
                        <main class="comment__main" v-cloak>
                            <div v-show="has_error"
                                 class="message message--error content content--thin">
                                ${error_msg}
                            </div>
                            <div id="{{ comment.comment_id }}" v-show="!editing"
                                 v-html="comment_computed">
                            </div>
                            {% if comment.photo_url %}
                                <div class="comment_main__photo">
                                    <img src="https://s3-{{ region }}.amazonaws.com/{{ bucket }}/{{ comment.photo_url }}"
                                         alt="{{ comment.comment }}">
                                </div>
                            {% endif %}
                            {% if (isSigned and comment.user_id == user_id) %}
                                <div v-if="editing">
                                    <form action="{{ path_for('update_comment') }}" method="post"
                                          class="js-edit-form">
                                        <label for="comment">
                                            <textarea name="comment" class="comment_form__comment"
                                                      v-model="comment" maxlength="400" required></textarea>
                                        </label>
                                        <input type="hidden" name="comment_id" value="{{ comment.comment_id }}">
                                        <input type="hidden" name="thread_id" value="{{ thread_id }}">
                                        <input type="hidden" name="_METHOD" value="PUT">
                                        <input type="submit" value="変更" class="button--small js-update"
                                               data-comment="{{ comment.comment_id }}"
                                               id="update-{{ comment.comment_id }}"
                                               @click="editEnd">
                                        <button class="comment__cancel button--small"
                                                @click="editCancel">キャンセル
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                        </main>
                        <footer class="comment__footer">
                            <div class="comment__footer_delete">
                                {% if is_admin or (isSigned and comment.user_id == user_id) %}
                                    <form action="{{ path_for('delete_comment') }}" method="post">
                                        <input type="hidden" name="comment_id" value="{{ comment.comment_id }}">
                                        <input type="hidden" name="thread_id" value="{{ thread_id }}">
                                        <input type="hidden" name="{{ nameKey }}" value="{{ name }}">
                                        <input type="hidden" name="{{ valueKey }}" value="{{ value }}">
                                        <input type="hidden" name="_METHOD" value="DELETE">
                                        <input type="submit" value="削除" class="comment_delete button--small"
                                               @click="deleteConfirm">
                                    </form>
                                {% else %}
                                    &nbsp;
                                {% endif %}
                            </div>
                            {% if (isSigned and comment.user_id == user_id) %}
                                <button class="button--small"
                                        @click="editStart" v-if="!editing">編集
                                </button>
                            {% endif %}
                            {% if loggedIn %}
                                <div>
                                    <form action="javascript: void(0);" method="post" id="like-{{ comment.comment_id }}"
                                          class="js-like" data-like="{{ comment.like_count }}">
                                        <input type="hidden" name="comment_id" value="{{ comment.comment_id }}">
                                        <input type="hidden" name="thread_id" value="{{ thread_id }}">
                                        <input type="submit" :value="soudane"
                                               class="button--small button--like"
                                               id="like-{{ comment.comment_id }}--submit"
                                               @click="addLike"
                                               :disabled="unsent">
                                    </form>
                                </div>
                            {% else %}
                                <div>
                                    そうだね&#215;<span
                                            id="like-{{ comment.comment_id }}_like">{{ comment.like_count }}</span>
                                </div>
                            {% endif %}
                        </footer>
                    </section>
                {% endfor %}
            {% else %}
                コメントがありません。
            {% endif %}
        </article>
    </div>
    {% if sort == 'asc' %}
        {% include "comment_form.twig" with {
            'thread_id': thread_id,
            'sort': sort,
            'user_id': user_id,
            'nameKey': nameKey,
            'name': name,
            'valueKey': valueKey,
            'value': value
        } %}
    {% endif %}
{% endblock %}
{% block scripts %}
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
    <script>
        const add_like_path = '' + '{{ path_for('add_like') }}';
        const update_path = '' + '{{ path_for('update_comment') }}';
    </script>
    <script src="{{ base_url() }}/assets/js/bundle.js"></script>
{% endblock %}