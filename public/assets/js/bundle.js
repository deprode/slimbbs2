"use strict";const twitter_embed='<blockquote class="twitter-tweet"><a href="$url"></a></blockquote>',link_html='<a href="{url}" target="_new">{url}</a>',reg=/^https?:\/\/twitter.com\/(.*)\/(status|statuses)\/(\d+)$/,reg_link=/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,})/;window.twttr=function(t,e,n){var o,r=t.getElementsByTagName(e)[0],i=window.twttr||{};return t.getElementById(n)?i:((o=t.createElement(e)).id=n,o.src="https://platform.twitter.com/widgets.js",r.parentNode.insertBefore(o,r),i._e=[],i.ready=function(t){i._e.push(t)},i)}(document,"script","twitter-wjs");class Comment{constructor(t,e){this._comment=e,this.id=t,this.user_id=e.user_id,this.comment_id=e.comment_id,this.comment=e.comment,this.pre_comment=e.comment,this.like_form_id="like-"+e.comment_id,this.count=e.like_count,this.edit=!1,this.unsent=!1,this.error_msg=""}}function build_comment(t){let e=t.split("\n");return(e=e.map(function(t){return reg.test(t)?twitter_embed.replace("$url",t):reg_link.test(t)?link_html.replace(/{url}/g,t):t})).join("<br/>")}document.getElementById("top_comment").innerHTML=build_comment(document.getElementById("top_comment").dataset.comment);const vm=new Vue({delimiters:["${","}"],el:"#js-comments",data:{comments:[],error_msg:"",last_id:Number.MAX_SAFE_INTEGER,loading:!1},created:function(){this.fetchComment()},updated:function(){this.comments.map((t,e)=>{twttr.widgets.load(document.getElementById("c"+t.comment_id))})},methods:{fetchComment:function(){this.loading||(this.loading=!0,fetch(fetch_path+this.last_id,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(t=>{if(!t.ok)throw Error(t.statusText);return t.json()}).then(t=>{this.error_msg="";const e=Object.keys(t).map((e,n)=>new Comment(e,t[e]));this.comments.push(...e),this.last_id=this.comments[this.comments.length-1].comment_id}).catch(t=>{this.error_msg="コメントを取得できませんでした。"}).finally(()=>{this.loading=!1}))},isOwned:function(t){return t===user_id},editing:function(t){return t.edit},soudane:function(t){return"そうだね ×"+t.count},has_error:function(t){return""!==t.error_msg},comment_computed:build_comment,editStart:function(t){t.edit=!0,t.pre_comment=t.comment},editCancel:function(t,e){e.preventDefault(),t.edit=!1,t.comment=t.pre_comment,t.error_msg=""},editEnd:function(t,e){e.preventDefault(),t.edit=!1,t.error_msg="";const n=document.getElementById(e.target.id).parentElement;fetch(update_path,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:new FormData(n)}).then(e=>{if(!e.ok)throw Error(e.statusText);t.error_msg=""}).catch(e=>{t.edit=!0,t.comment=t.pre_comment,t.error_msg="保存できませんでした。"}),t.pre_comment=t.comment},addLike:function(t){if(t.unsent)return;const e=new FormData(document.getElementById(t.like_form_id));this.plus1(e,t),t.error_msg=""},plus1:function(t,e){const n=this;fetch(add_like_path,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:t}).then(function(t){if(!t.ok)throw Error(t.statusText);n.updateCount(e),n.disabledButton(e)}).catch(t=>{this.error_msg="「そうだね」できませんでした。"})},updateCount:function(t){t.count=parseInt(t.count)+1},disabledButton:function(t){t.unsent=!0},deleteConfirm:function(t){!1===confirm("このコメントを削除しますか？")&&t.preventDefault()},scrolling:function(t){const e=document.body,n=document.documentElement,o=e.scrollTop||n.scrollTop;n.scrollHeight-o-n.clientHeight<=0&&!this.loading&&this.fetchComment()}},beforeMount:function(){window.addEventListener("scroll",this.scrolling)},afterMount:function(){window.removeEventListener("scroll",this.scrolling)}});